ubuntu 20.04 adding a cgroup and init'ing with systemd

sudo apt-get install cgroup-tools (need to select Yes)

sudo vim /etc/default/grub

# Uncomment to enable memory management
GRUB_CMDLINE_LINUX="quiet cgroup_enable=memory swapaccount=1"

sudo update-grub

to verify memory management has been enabled
ls /sys/fs/cgroup/

use template for global config to create a global config
sudo cp /usr/share/doc/cgroup-tools/examples/cgred.conf /etc/

create file to specify groups
sudo touch /etc/cgconfig.conf

edit file to create a group and limit the memory
group memlimit {
    memory {
        memory.limit_in_bytes = 500000000;
    }
}

create file to allocate programs to groups
sudo touch /etc/cgrules.conf

edit file to apply roles to applications in group, something like
*:emacs         cpu,memory      app/editor/
*:conkeror      cpu,memory      app/browser/
*:firefox       cpu,memory      app/browser/
*:slack         cpu,memory      app/util/
*:dropbox       cpu,memory      app/util/

apply the rules
sudo cgconfigparser -l /etc/cgconfig.conf && sudo cgrulesengd

check the rules
sudo cgget -g memory:memlimit


create a systemd file apply rules to be parsed and applied at boot
sudo touch /etc/systemd/system/cgconfigparser.service
[Unit]
Description=cgroup config parser
After=network.target

[Service]
User=root
Group=root
ExecStart=/usr/sbin/cgconfigparser -l /etc/cgconfig.conf
Type=oneshot

[Install]
WantedBy=multi-user.target

and create another systemd file for the rules
[Unit]
Description=cgroup rules generator
After=network.target cgconfigparser.service

[Service]
User=root
Group=root
Type=forking
EnvironmentFile=-/etc/cgred.conf
ExecStart=/usr/sbin/cgrulesengd
Restart=on-failure

[Install]
WantedBy=multi-user.target

then run
sudo systemctl daemon-reload && sudo systemctl enable cgconfigparser --now && sudo systemctl enable cgrulesgend --now

to view the group and verify it has been created and is handling memory management
ls /sys/fs/cgroup/memory/

to apply rule changes without rebooting
sudo systemctl restart cgconfigparser && sudo systemctl restart cgrulesgend


/*
RESOURCES:
https://www.lesbonscomptes.com/recoll/faqsandhowtos/cgroups_instructions.html
http://www.fernandoalmeida.net/blog/how-to-limit-cpu-and-memory-usage-with-cgroups-on-debian-ubuntu/
https://linuxmedium.com/how-to-enable-etc-rc-local-with-systemd-on-ubuntu-20-04/
https://unix.stackexchange.com/questions/34334/how-to-create-a-user-with-limited-ram-usage
*/